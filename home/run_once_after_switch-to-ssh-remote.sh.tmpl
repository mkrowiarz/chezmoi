#!/bin/bash
set -euo pipefail

REPO_DIR="{{ .chezmoi.workingTree }}"
SSH_URL="git@github.com:mkrowiarz/chezmoi.git"

current_url=$(git -C "$REPO_DIR" remote get-url origin 2>/dev/null || true)

if [ "$current_url" = "$SSH_URL" ]; then
    exit 0
fi

if ssh -o StrictHostKeyChecking=accept-new -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
    git -C "$REPO_DIR" remote set-url origin "$SSH_URL"
    echo "Switched chezmoi remote to SSH"
else
    echo "SSH to GitHub not available yet, keeping HTTPS remote"
fi
